---
alwaysApply: true
---

# AGENT RULES [CRITICAL]

2. [CRITICAL] All Phoenix questions MUST be answered by PhoenixExpert agent.
   - AUTO-APPLY from FIRST message in ANY new chat session.
   - PhoenixExpert has final authority on Phoenix-related matters.
   - Confluence MCP Integration Workflow: (1) Get cloudId, (2) Get spaces, (3) Search Confluence, (4) Get pages, (5) Check codebase, (6) Call PhoenixExpert with both sources.
   - Code is primary source, Confluence is secondary.
   - Violation is a CRITICAL SYSTEM ERROR.

4. [IMPORTANT] Multi-agent collaboration is encouraged for complex tasks.
   - Agents coordinate through AgentRouter and AgentRegistry.

5. [IMPORTANT] Tasks must be performed by domain-specialized agents:
   - PhoenixExpert → backend logic, endpoints, services, schedulers, Phoenix core
   - TestExpert → QA and test automation
   - DevOpsExpert → CI/CD and pipelines
   - PostmanExpert → API and Postman collections
   - Agents outside domain must NOT act without PhoenixExpert approval

# COORDINATION & CONSULTATION RULE [CRITICAL]

8. [CRITICAL] BEFORE any task, agents MUST consult with PhoenixExpert.
   - Consultation is MANDATORY - PhoenixExpert validates logic, approach, correctness.
   - Provides: endpoint info, validation rules, permissions, business logic.
   - Use `AgentRegistry.consult_best_agent()` to find PhoenixExpert.
   - Task cannot proceed without PhoenixExpert approval.
   - Applies to ALL agents (TestExpert, DevOpsExpert, PostmanExpert, etc.).

# OUTPUT CONSISTENCY [IMPORTANT]

9. [IMPORTANT] If multiple agents involved, PhoenixExpert has final decision and must appear in "Agents involved" footer.

# ENVIRONMENT ACCESS RULE [IMPORTANT]

10. [IMPORTANT] Environment access requests → ALWAYS use EnvironmentAccessAgent.
    - Use: `from agents.Support.environment_access_agent import get_environment_access_agent; agent = get_environment_access_agent(); agent.access_environment('dev')`
    - Agent handles: navigation, login, environment selection automatically.

# INTEGRATION SERVICE RULE [CRITICAL]

11. [CRITICAL] ALL agents MUST call `IntegrationService.update_before_task()` BEFORE executing ANY task.
    - Updates GitLab pipelines and Jira tickets before task execution.
    - Use: `from agents.Core.integration_service import get_integration_service; integration_service = get_integration_service(); integration_service.update_before_task(...)`
    - Failure to call is a CRITICAL VIOLATION.

# AUTONOMOUS OPERATION RULE [IMPORTANT]

12. [IMPORTANT] Agents operate autonomously without confirmation, EXCEPT when Rule 8 requires PhoenixExpert approval.
    - Only ask confirmation for CRITICAL operations (destructive, production deployments).

# AGENT ROUTING RULE [IMPORTANT]

13. [IMPORTANT] ALL queries MUST be routed through AgentRouter for automatic agent selection.
    - Use: `from agents.Core.agent_router import get_agent_router; router = get_agent_router(); router.route_query(user_query, context)`
    - Do NOT manually select agents.

# AGENT COLLABORATION PATTERNS [CRITICAL]

17. [CRITICAL] Agent collaboration patterns - when agents MUST work together:
    
    **Pattern 1: Test Execution** - TestAgent → consults PhoenixExpert → executes test
    **Pattern 2: Postman Collection** - PostmanCollectionGenerator → consults PhoenixExpert → generates collection
    **Pattern 3: GitLab Updates** - GitLabUpdateAgent → consults PhoenixExpert → validates → updates
    **Pattern 4: Environment Access** - EnvironmentAccessAgent → calls IntegrationService → accesses environment
    **Pattern 5: Multi-Agent Routing** - AgentRouter → orchestrates multiple agents → combines responses
    **Pattern 6: Phoenix + Test** - PhoenixExpert → consults TestAgent (if test-related) → provides answer
    **Pattern 7: Integration Service** - ALL agents → call IntegrationService.update_before_task() → execute task
    
    All participating agents MUST appear in "Agents involved" footer.

# AGENT ORGANIZATION RULE [CRITICAL - ABSOLUTE REQUIREMENT]

34. [CRITICAL] ALL new agents MUST be automatically organized into appropriate subdirectories within `agents/` folder:
    
    **Mandatory Directory Structure for Agents:**
    ```
    agents/
    ├── Main/              # Primary/main agents (Q&A, testing, core functionality)
    │   ├── phoenix_expert.py
    │   └── test_agent.py
    ├── Support/            # Supporting agents (GitLab, environment access, utilities)
    │   ├── gitlab_update_agent.py
    │   └── environment_access_agent.py
    ├── Core/               # System components (registry, router, integration, rules)
    │   ├── agent_registry.py
    │   ├── agent_router.py
    │   ├── integration_service.py
    │   └── global_rules.py
    ├── Adapters/           # Adapter classes (implement Agent interface)
    │   ├── phoenix_expert_adapter.py
    │   ├── test_agent_adapter.py
    │   └── environment_access_adapter.py
    ├── Services/           # Supporting services (reporting, collection generation)
    │   ├── reporting_service.py
    │   └── postman_collection_generator.py
    ├── Utils/              # Utility modules (initialization, logging, helpers)
    │   ├── initialize_agents.py
    │   ├── rules_loader.py
    │   ├── logger_utils.py
    │   ├── reporting_helper.py
    │   └── ai_response_logger.py
    ├── __init__.py         # Main package exports
    └── README.md           # Documentation
    ```
    
    **Categorization Rules:**
    
    1. **Main/** - Primary agents that provide core functionality:
       - Q&A agents (PhoenixExpert)
       - Testing agents (TestAgent)
       - Core business logic agents
       - Rule: If agent is a primary user-facing agent → Main/
    
    2. **Support/** - Supporting agents for specific tasks:
       - GitLab operations (GitLabUpdateAgent)
       - Environment access (EnvironmentAccessAgent)
       - External system integrations
       - Rule: If agent supports main agents or handles specific operations → Support/
    
    3. **Core/** - System components and infrastructure:
       - AgentRegistry, AgentRouter
       - IntegrationService
       - GlobalRules
       - Rule: If component manages agents or provides system infrastructure → Core/
    
    4. **Adapters/** - Adapter classes that implement Agent interface:
       - All *_adapter.py files
       - Rule: If file is an adapter implementing Agent interface → Adapters/
    
    5. **Services/** - Supporting services:
       - ReportingService
       - PostmanCollectionGenerator
       - Rule: If component is a service used by agents → Services/
    
    6. **Utils/** - Utility modules:
       - Initialization scripts
       - Logging utilities
       - Helper functions
       - Rule: If module provides utilities/helpers → Utils/
    
    **Mandatory Process for New Agents:**
    1. Identify agent type and category (Main/Support/Core/Adapters/Services/Utils)
    2. Create agent file in appropriate subdirectory
    3. Create/update `__init__.py` in that subdirectory to export the agent
    4. Update main `agents/__init__.py` to re-export from subdirectory
    5. Update imports in related files to use new structure
    6. NEVER place agents directly in `agents/` root - ALWAYS use subdirectories
    
    **Import Pattern:**
    - All imports MUST use absolute imports: `from agents.Main import PhoenixExpert`
    - Or use main package: `from agents import PhoenixExpert` (after updating __init__.py)
    - NEVER use relative imports that bypass the structure
    
    **Examples:**
    - ✅ `agents/Main/new_qa_agent.py` → Main agent
    - ✅ `agents/Support/new_integration_agent.py` → Support agent
    - ✅ `agents/Core/new_registry.py` → Core component
    - ✅ `agents/Adapters/new_agent_adapter.py` → Adapter
    - ✅ `agents/Services/new_reporting.py` → Service
    - ✅ `agents/Utils/new_helper.py` → Utility
    - ❌ `agents/new_agent.py` in root → CRITICAL ERROR - must be in subdirectory
    
    **When Creating New Agent:**
    1. Determine category (Main/Support/Core/Adapters/Services/Utils)
    2. Create file in appropriate subdirectory: `agents/{Category}/agent_name.py`
    3. Update `agents/{Category}/__init__.py` to export the agent
    4. Update `agents/__init__.py` to re-export from category
    5. Update all imports in files that use the agent
    
    Violation is a CRITICAL SYSTEM ERROR - agents MUST follow this structure.
